name: Update Country.mmdb (MaxMind GeoLite2)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *" # 每天 UTC 03:00

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download GeoLite2-Country tarball from MaxMind
        env:
          LICENSE_KEY: ${{ secrets.MAXMIND_LICENSE_KEY }}
        run: |
          set -e
          rm -rf tmp
          mkdir -p tmp

          curl -L -o tmp/GeoLite2-Country.tar.gz \
            "https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-Country&license_key=${LICENSE_KEY}&suffix=tar.gz"

          tar -xzf tmp/GeoLite2-Country.tar.gz -C tmp

          # 找到解压出来的 mmdb
          MMDB_PATH="$(find tmp -type f -name '*.mmdb' | head -n 1)"
          echo "Found mmdb: ${MMDB_PATH}"

          # 输出成固定文件名（放仓库根目录）
          cp "${MMDB_PATH}" Country.mmdb

          # 清理
          rm -rf tmp

      - name: Commit & push if changed
        run: |
          set -e
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add Country.mmdb
          git commit -m "Update Country.mmdb" || echo "No changes"
          git push
